<html>
<head>
<script type="text/javascript" src="jquery-1.5.min.js"></script>
<script>
var months = ["Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec"];

function getStorage(key,defaultValue) {
   if (localStorage[key] == undefined)
      return defaultValue;
   else
      return localStorage[key];
}

function zeroPad(num, len) {
   var ret = "";
   ret += num;
   while (ret.length < len) ret = "0" + ret;
   return ret;
}

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
   if (!sender.tab) sendResponse({});
   else if (request.greeting == "timestamp") {
      $.ajax({
         type: "GET",
         url: request.url + '/api/read/json',
         data: "id="+request.pid,
         dataType: "text",
         tryCount: 0,
         retryLimit: getStorage("MissingE_timestamp_retries",10),
         targetId: request.pid,
         error: function(xhr, textStatus) {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               $.ajax(this);
               return;
            }
            else {
               sendResponse({pid: this.targetId, success: false});

            }
         },
         success: function(data, textStatus) {
            if (!(/^\s*var\s+tumblr_api_read/.test(data))) {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  $.ajax(this);
                  return;
               }
            }
            else {
               var txt = data.replace(/^\s*var\s+tumblr_api_read\s+=\s+/,'').replace(/;\s*$/,'');
               var stamp = JSON.parse(txt);
               var ts = stamp["posts"][0]["unix-timestamp"];
               var d = new Date(ts*1000);
               var ins = getStorage("MissingE_timestamps_format","%Y-%m-%D %H:%i");
               ins = ins.replace(/%Y/g,d.getFullYear())
                  .replace(/%y/g,(d.getFullYear()%100))
                  .replace(/%M/g,months[d.getMonth()])
                  .replace(/%m/g,zeroPad(d.getMonth()+1,2))
                  .replace(/%n/g,(d.getMonth()+1))
                  .replace(/%D/g,zeroPad(d.getDate(),2))
                  .replace(/%d/g,d.getDate())
                  .replace(/%G/g,zeroPad((d.getHours()%12==0 ? "12" : d.getHours()%12),2))
                  .replace(/%g/g,(d.getHours()%12==0 ? "12" : d.getHours()%12))
                  .replace(/%H/g,zeroPad(d.getHours(),2))
                  .replace(/%h/g,d.getHours())
                  .replace(/%i/g,zeroPad(d.getMinutes(),2))
                  .replace(/%s/g,zeroPad(d.getSeconds(),2))
                  .replace(/%A/g,(d.getHours() < 12 ? "AM" : "PM"))
                  .replace(/%a/g,(d.getHours() < 12 ? "am" : "pm"));
               sendResponse({pid: this.targetId, success: true, data: ins});
            }
         }
      });
   }
   else if (request.greeting == "settings") {
      var settings = {};
      switch(request.component) {
         case "replyReplies":
            settings.showAvatars = getStorage("MissingE_replyReplies_showAvatars",1);
            settings.addTags = getStorage("MissingE_replyReplies_addTags",1);
            break;
         case "postCrushes":
            settings.prefix = getStorage("MissingE_postCrushes_prefix","Tumblr Crushes:");
            settings.crushSize = getStorage("MissingE_postCrushes_crushSize",1);
            settings.addTags = getStorage("MissingE_postCrushes_addTags",1);
            settings.showPercent = getStorage("MissingE_postCrushes_showPercent",1);
            break;
         case "postingFixes":
            settings.photoReplies = getStorage("MissingE_postingFixes_photoReplies",1);
            settings.uploaderToggle = getStorage("MissingE_postingFixes_uploaderToggle",1);
            break;
      }
      sendResponse(JSON.stringify(settings));
   }
   else if (request.greeting == "start") {
      chrome.tabs.executeScript(sender.tab.id, {file: "common/jquery-1.5.min.js"});
      chrome.tabs.executeScript(sender.tab.id, {file: "common/storage.js"});
      chrome.tabs.executeScript(sender.tab.id, {file: "common/utils.js"});
      var activeScripts = {};
      if (/http:\/\/www\.tumblr\.com\/dashboard/.test(sender.tab.url)) {
         if (getStorage("MissingE_dashLinksToTabs_enabled",1) == 1) {
            activeScripts.dashLinksToTabs = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "dashLinksToTabs/dashLinksToTabs.js"});
         }
         else
            activeScripts.dashLinksToTabs = false;
      }
      if (/http:\/\/www\.tumblr\.com\/dashboard/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/drafts/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/likes/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/messages/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/queue/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/tumblelog/.test(sender.tab.url)) {
         if (getStorage("MissingE_safeDash_enabled",1) == 1) {
            activeScripts.safeDash = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "safeDash/safeDash.js"});
         }
         else
            activeScripts.safeDash = false;
         
         if (getStorage("MissingE_bookmarker_enabled",1) == 1) {
            activeScripts.bookmarker = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "bookmarker/bookmarker.js"});
         }
         else
            activeScripts.bookmarker = false;
   
         if (getStorage("MissingE_unfollower_enabled",1) == 1 ||
             getStorage("MissingE_followChecker_enabled",1) == 1) {
            chrome.tabs.executeScript(sender.tab.id, {file: "facebox/facebox.js"});
            chrome.tabs.insertCSS(sender.tab.id, {file: "facebox/facebox.css"});
         }

         if (getStorage("MissingE_unfollower_enabled",1) == 1) {
            activeScripts.unfollower = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "unfollower/unfollower.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "unfollower/unfollower.js"});
         }
         else
            activeScripts.unfollower = false;

         if (getStorage("MissingE_followChecker_enabled",1) == 1) {
            activeScripts.followChecker = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "followChecker/followChecker.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "followChecker/followChecker.js"});
         }
         else
            activeScripts.followChecker = false;
      }
      if (/http:\/\/www\.tumblr\.com\/dashboard/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/drafts/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/likes/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/queue/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/tumblelog/.test(sender.tab.url)) {
         if (getStorage("MissingE_reblogQuoteFit_enabled",1) == 1) {
            activeScripts.reblogQuoteFit = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "reblogQuoteFit/reblogQuoteFit.css"});
         }
         else
            activeScripts.reblogQuoteFit = false;
      }
      if (/http:\/\/www\.tumblr\.com\/.*new\//.test(sender.tab.url)) {
         if (getStorage("MissingE_postingFixes_enabled",1) == 1) {
            activeScripts.postingFixes = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "postingFixes/postingFixes.js"});
         }
         else
            activeScripts.postingFixes = false;
      }
      if (/http:\/\/www\.tumblr\.com\/dashboard\/iframe/.test(request.url)) {
         if (getStorage("MissingE_gotoDashPost_enabled",1) == 1) {
            activeScripts.gotoDashPost = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "gotoDashPost/gotoDashPost.js", allFrames: true});
         }
         else
            activeScripts.gotoDashPost = false;

         if (getStorage("MissingE_reblogYourself_enabled",1) == 1) {
            activeScripts.reblogYourself = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "reblogYourself/reblogYourself.js", allFrames: true});
         }
         else
            activeScripts.reblogYourself = false;
      }
      if (/http:\/\/www\.tumblr\.com\/dashboard/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/tumblelog/.test(sender.tab.url)) {
         if (getStorage("MissingE_replyReplies_enabled",1) == 1) {
            activeScripts.replyReplies = true;
            chrome.tabs.insertCSS(sender.tab.id, {code: "#posts .notification .notification_type_icon { cursor: pointer; } #posts .notification .notification_type_icon:hover { background-image:url('" + chrome.extension.getURL('replyReplies/notification_icons.png') + "') !important; }"});
            chrome.tabs.executeScript(sender.tab.id, {file: "replyReplies/replyReplies.js"});
         }
         else
            activeScripts.replyReplies = false;
      }
      if (/http:\/\/www\.tumblr\.com\/new\/text/.test(sender.tab.url)) {
         if (getStorage("MissingE_replyReplies_enabled",1) == 1) {
            activeScripts.replyReplies = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "replyReplies/replyReplies_fill.js"});
         }
         else
            activeScripts.replyReplies = false;
      }
      if (/http:\/\/www\.tumblr\.com\/following/.test(sender.tab.url)) {
         if (getStorage("MissingE_postCrushes_enabled",1) == 1) {
            activeScripts.postCrushes = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "postCrushes/postCrushes.js"});
         }
         else
            activeScripts.postCrushes = false;
      }
      if (/http:\/\/www\.tumblr\.com\/new\/photo/.test(sender.tab.url)) {
         if (getStorage("MissingE_postCrushes_enabled",1) == 1) {
            activeScripts.postCrushes = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "postCrushes/postCrushes_fill.js"});
         }
         else
            activeScripts.postCrushes = false;
      }
      if ((/http:\/\/www\.tumblr\.com\/dashboard/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/tumblelog/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/likes/.test(sender.tab.url)) &&
          !(/http:\/\/www\.tumblr\.com\/tumblelog\/[^\/]*\/(messages|drafts|queue)/.test(sender.tab.url))) {
         if (getStorage("MissingE_timestamps_enabled",1) == 1) {
            activeScripts.timestamps = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "timestamps/timestamps.js"});
         }
         else
            activeScripts.timestamps = false;
      }
      activeScripts.url = request.url;
      sendResponse(JSON.stringify(activeScripts));
   }
});

</script>
</head>
</html>
