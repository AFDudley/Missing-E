<!--
 - 'Missing e' Extension
 -
 - Copyright 2011, Jeremy Cutler
 - Released under the GPL version 3 licence.
 - SEE: GPL-LICENSE.txt
 -
 - This file is part of 'Missing e'.
 -
 - 'Missing e' is free software: you can redistribute it and/or modify
 - it under the terms of the GNU General Public License as published by
 - the Free Software Foundation, either version 3 of the License, or
 - (at your option) any later version.
 -
 - 'Missing e' is distributed in the hope that it will be useful,
 - but WITHOUT ANY WARRANTY; without even the implied warranty of
 - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 - GNU General Public License for more details.
 -
 - You should have received a copy of the GNU General Public License
 - along with 'Missing e'.  If not, see [http://www.gnu.org/licenses/].
-->
<html>
<head>
<script type="text/javascript" src="common/jquery.min.js"></script>
<script type="text/javascript" src="common/localizations.js"></script>
<script type="text/javascript" src="common/defs.js"></script>
<script type="text/javascript" src="common/utils.js"></script>
<script>
var componentList = ["dashboardFixes",
                     "bookmarker",
                     "dashLinksToTabs",
                     "safeDash",
                     "timestamps",
                     "magnifier",
                     "betterReblogs",
                     "gotoDashPost",
                     "postingFixes",
                     "reblogYourself",
                     "askFixes",
                     "postCrushes",
                     "replyReplies",
                     "massEditor",
                     "sidebarTweaks"];

var maxActiveAjax = 15;
var activeAjax = 0;
var activeRequests = {};
var onHold = {};
var numSleeping = 0;
var waitQueue = [];
var cache = {};
var cacheElements = 0;
var cacheClear;
var clearQueues;
var askerTable = {};
var askerWaiters = {};
var askerTableCopy = {};
var askerTableClear;
var fiveMinutes = 300000;
var tenSeconds = 10000;
var debugMode = false;
var lang = 'en';

function getStorage(key, defVal) {
   var retval = safari.extension.settings[key];
   if (retval === undefined || retval === null || retval === "") {
      return defVal;
   }
   else {
      if (/[^0-9]/.test(retval)) {
         return retval;
      }
      else {
         return parseInt(retval, 10);
      }
   }
}

function getVersion() {
   return getStorage("MissingE_version",'');
}

var currVersion = getVersion();
var prevVersion = getStorage('MissingE_installedVersion',null);

function setStorage(key, val) {
   safari.extension.settings[key] = val;
}

askerTableClear = setInterval(function() {
   var i;
   for (i in askerTableCopy) {
      if (askerTableCopy.hasOwnProperty(i) &&
          askerTable.hasOwnProperty(i)) {
         delete askerTable[i];
      }
   }
   askerTableCopy = {};
   for (i in askerTable) {
      if (askerTable.hasOwnProperty(i)) {
         askerTableCopy[i] = true;
      }
   }
}, fiveMinutes);

cacheClear = setInterval(function() {
   cache = {};
   cacheElements = 0;
}, fiveMinutes);
clearQueues = setInterval(function() {
   if (activeAjax == 0) {
      if (numSleeping !== 0) {
         debug(numSleeping + " still sleeping");
      }
      if (waitQueue.length > 0) {
         debug(waitQueue.length + " still queued");
      }
   }
}, tenSeconds);

function debug(msg) {
   if (debugMode) {
      console.log(msg);
   }
}

safari.extension.addContentScriptFromURL(safari.extension.baseURI +
                                  "common/getOptions.js",
                                  safari.extension.baseURI +
                                  "common/getOptions.html", null, true);

function exportOptionsXML(request) {
   request.target.page.dispatchMessage("exportOptions", {url: "http://tools.missinge.infraware.ca/settings?" + $.param(createOptionParams())});
}

function isInternalSetting(setting) {
   return !/^MissingE_/.test(setting) ||
          setting === "MissingE_version" ||
          setting === "MissingE_installedVersion" ||
          /MissingE_externalVersion/.test(setting) ||
          setting === "MissingE_compatCheck" ||
          !/^[a-zA-Z0-9_]*$/.test(setting);
}

function createOptionParams() {
   var opts = {};
   for (setting in safari.extension.settings) {
      if (safari.extension.settings.hasOwnProperty(setting) &&
          !isInternalSetting(setting)) {
         opts[setting] = safari.extension.settings[setting];
      }
   }
   return opts;
}

function receiveOptions(request) {
   var currSettings = {};
   var changed, set, reset;
   changed = set = reset = 0;
   for (i in safari.extension.settings) {
      if (safari.extension.settings.hasOwnProperty(i)) {
         currSettings[i] = safari.extension.settings[i];
      }
   }
   var settings = request.message.data;
   for (i in settings) {
      if (settings.hasOwnProperty(i)) {
         if (!currSettings.hasOwnProperty(i) ||
             currSettings[i] != settings[i]) {
            var done = false;
            if (typeof safari.extension.settings[i] === "number") {
               var val = parseInt(settings[i]);
               if (!isNaN(val)) {
                  done = true;
                  safari.extension.settings[i] = val;
               }
            }
            else {
               done = true;
               safari.extension.settings[i] = settings[i];
            }
            if (done) {
               var old = "'" + currSettings[i] + "'";
               if (currSettings[i] === undefined) {
                  old = "undefined";
                  set++;
               }
               else {
                  changed++;
               }
               debug(i + " [" + old + " => '" +
                           settings[i] + "']");
            }
         }
      }
   }
   for (i in currSettings) {
      if (currSettings.hasOwnProperty(i) &&
          !settings.hasOwnProperty(i) &&
          !isInternalSetting(i)) {
         reset++;
         safari.extension.settings.removeItem(i);
      }
   }
   if (set + changed + reset > 0) {
      alert("Import complete.\n\n" + (set+changed+reset) + " change(s) made.");
      request.target.page.dispatchMessage("importOptions", {success:true});
   }
   else {
      alert("No changes imported.");
      request.target.page.dispatchMessage("importOptions", {success:false});
   }
}

function doTags(stamp, id, request) {
   if (!stamp.tags) {
      debug("Cache entry does not have tags");
      return false;
   }
   var tags = stamp.tags;
   if (!tags) {
      tags = [];
   }
   request.target.page.dispatchMessage("tags",{success: true, data: tags});
}

function doTimestamp(stamp, id, request) {
   if (!stamp.timestamp) {
      debug("Cache entry does not have timestamp");
      return false;
   }
   var ts = stamp.timestamp;
   var d = new Date(ts*1000);
   if (isNaN(d)) {
      request.target.page.dispatchMessage("timestamp",{pid: id, success: false});
   }
   var ins = getStorage("MissingE_timestamps_format",defaultFormat);
   ins = getFormattedDate(d, ins, lang);
   request.target.page.dispatchMessage("timestamp",{pid: id, success: true, data: ins});
   return true;
}

function doReblogDash(stamp, id, request) {
   if (!stamp.reblog_key) {
      debug("Cache entry does not have reblog key.");
      return false;
   }
   var key = stamp.reblog_key;
   var name = stamp.name;
   var replaceIcons = getStorage("MissingE_dashboardFixes_enabled",1) == 1 &&
                      getStorage("MissingE_dashboardFixes_replaceIcons",1) == 1;
   request.target.page.dispatchMessage(request.name,{pid: id, success: true, data: key, name: name, icons: replaceIcons});
   return true;
}

function queueAjax(details) {
   waitQueue.push(details);
   debug("Queueing " + details.type + " request. " + (waitQueue.length) +
         " in queue");
}

function runItem(call) {
   if (call.type === "reblogYourself") {
      requestReblogYourself(call.request);
   }
   else if (call.type === "betterReblogs") {
      requestBetterReblogsAsk(call.request);
   }
   else if (call.type === "timestamp") {
      requestTimestamp(call.request);
   }
   else if (call.type === "tags") {
      requestTags(call.request);
   }
}

function dequeueAjax(id) {
   if (id) {
      activeAjax--;
      wakeById(id);
      delete activeRequests[id];
   }
   while (activeAjax < maxActiveAjax) {
      var call = waitQueue.shift();
      if (!call) { return false; }
      debug("Dequeueing " + call.type + " request. " + (waitQueue.length) +
            " in queue");
      runItem(call);
   }
}

function saveCache(id, entry) {
   var theEntry;
   var isNew = true;
   if ((theEntry = cache[id])) {
      debug("Saving " + id + " to cache (HIT)");
      isNew = false;
   }
   else {
      debug("Saving " + id + " to cache (MISS)");
      cacheElements++;
      theEntry = {};
   }
   for (var i in entry) {
      if (entry.hasOwnProperty(i)) {
         if (i == "photos" ||
             i == "timestamp" ||
             i == "reblog_key" ||
             i == "post_url" ||
             i == "tags" ||
             i == "type" ||
             (i == "name" && entry[i] != "")) {
            theEntry[i] = entry[i];
         }
      }
   }
   if (isNew) {
      cache[id] = theEntry;
   }
}

function cacheServe(type, id, request, fn, midFlight, notAjax) {
   var entry;
   if ((entry = cache[id])) {
      debug(type + " request (" + id + ") has cache entry.");
      if (midFlight && !notAjax) {
         dequeueAjax(id);
      }
      else if (!notAjax) {
         dequeueAjax();
      }
      return fn(entry, id, request);
   }
   else {
      return false;
   }
}

function wakeById(id) {
   var i,j;
   for (i=0; activeRequests[id] && i<activeRequests[id].length; i++) {
      var call;
      if ((call = activeRequests[id][i])) {
         delete onHold[call.type + call.request.message.pid];
         numSleeping--;
         debug("Selectively waking " + call.type + " request (" + call.request.message.pid + "). " + numSleeping + " still asleep");
         runItem(call);
      }
   }
}

function isRequested(details) {
   var bucket;
   if (!details.request.sleepCount) {
      details.request.sleepCount = 0;
   }
   if ((bucket = activeRequests[details.request.message.pid]) &&
       details.request.sleepCount < 5) {
      onHold[details.type + details.request.message.pid] = details;
      bucket.push(details);
      numSleeping++;
      details.request.sleepCount++;
      debug("Sleeping " + details.type + " request (" +
            details.request.message.pid + ") [" + details.request.sleepCount +
            "]. " + numSleeping + " asleep");
      return true;
   }
   else {
      return false;
   }
}

function startAjax(id) {
   activeAjax++;
   if (!activeRequests.hasOwnProperty(id)) {
      activeRequests[id] = [];
   }
}

function doAskAjax(request, retries, type, doFunc) {
   debug("AJAX " + type + " request (" + request.pid + ")");
   startAjax(request.message.pid);
   var failMsg = {success:false};
   $.ajax({
      type: "GET",
      url: request.message.url + request.message.pid,
      dataType: "html",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.message.pid,
      error: function(xhr, textStatus) {
         if (xhr.status == 404) {
            debug(type + " request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            request.target.page.dispatchMessage(type,failMsg);
            return;
         }
         if (request.target.page === undefined) {
            debug("Stop " + type + " request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         if (cacheServe(type, request.message.pid, request, doFunc, true)) {
            return true;
         }
         else {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               debug("Retry " + type + " request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               request.target.page.dispatchMessage(type,failMsg);
            }
         }
      },
      success: function(data, textStatus) {
         if (!(/<input[^>]*name="post\[date\]"[^>]*>/.test(data))) {
            if (request.target.page === undefined) {
               debug("Stop " + type + " request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe(type, request.message.pid, request, doFunc, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  debug("Retry " + type + " request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  debug(type + " request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  request.target.page.dispatchMessage(type,failMsg);
               }
            }
         }
         else {
            var failed = false;
            var txt;
            var inp = data.match(/<input[^>]*name="post\[date\]"[^>]*>/);
            if (!inp) { failed = true; }
            else {
               txt = inp[0].match(/value="([^"]*)"/);
               if (!txt || txt.length < 2) {
                  failed = true;
               }
               else {
                  txt = txt[1];
               }
            }
            if (failed) {
               debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               request.target.page.dispatchMessage(type,failMsg);
               return;
            }
            var m = txt.match(/([A-Za-z]+) ([0-9]+)[^,]*, ([0-9]+) ([0-9]+):([0-9]+)([aApP][mM])/);
            var d = new Date(m[1] + ' ' + m[2] + ', ' + m[3] + ' ' +
                             (m[6]=='pm' && m[4] !== '12' ? parseInt(m[4])+12 : m[4]) +
                             ':' + m[5] + ':00 GMT');
            var stamp = Math.round(d.getTime()/1000);
            var info = {"timestamp":stamp};
            saveCache(this.targetId, info);
            dequeueAjax(this.targetId);
            if (!closed) {
               doFunc(info, this.targetId, request);
            }
         }
      }
   });
}

function checkPermission(request, retries, tryCount) {
   var ajax = new XMLHttpRequest();
   ajax.open("HEAD", "http://www.tumblr.com/blog/" +
             request.message.user, true);
   if (!tryCount) { tryCount = 0; }
   ajax.onreadystatechange = function() {
      if (request.target.page === undefined) {
         return;
      }
      else if (this.readyState == 4) {
         if (this.status == 200) {
            request.target.page.dispatchMessage("tumblrPermission",
                                                {allow: true});
         }
         else if (this.status < 500) {
            request.target.page.dispatchMessage("tumblrPermission",
                                                {allow:false});
         }
         else {
            tryCount++;
            if (tryCount <= retries) {
               checkPermission(request, sender, sendResponse, hash, retries,
                               tryCount);
               return;
            }
            else {
               request.target.page.dispatchMessage("tumblrPermission",
                                                   {allow:false});
            }
         }
      }
   };
   ajax.send();
}

function doTagsAjax(request, retries) {
   debug("AJAX tags request (" + request.message.pid + ")");
   startAjax(request.message.pid);
   var failMsg = {success:false};
   $.ajax({
      type: "GET",
      url: request.message.url + "/post/" + request.message.pid + "/rss",
      dataType: "html",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.message.pid,
      error: function(xhr, textStatus) {
         if (xhr.status === 404) {
            debug("tags request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            request.target.page.dispatchMessage("tags",failMsg);
            return;
         }
         if (request.target.page === undefined) {
            debug("Stop tags request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         if (cacheServe("tags", request.message.pid, request, doTags, true)) {
            return true;
         }
         else {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               debug("Retry tags request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               debug("tags request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               request.target.page.dispatchMessage("tags",failMsg);
            }
         }
      },
      success: function(data, textStatus) {
         if (!(/<guid>[^<]*<\/guid>/.test(data))) {
            if (request.target.page === undefined) {
               debug("Stop tags request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe("tags", request.message.pid, request, doTags, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  debug("Retry tags request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  debug("tags request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  request.target.page.dispatchMessage("tags",failMsg);
               }
            }
         }
         else {
            var i;
            var tags = data.match(/<category>[^<]*<\/category>/g);
            if (!tags) { tags = []; }
            for (i=0; i<tags.length; i++) {
               tags[i] = tags[i].replace(/^<category>/,'')
                              .replace(/<\/category>$/,'');
            }
            var info = {"tags":tags};
            saveCache(this.targetId, info);
            dequeueAjax(this.targetId);
            if (request.target.page !== undefined) {
               doTags(info, this.targetId, request);
            }
         }
      }
   });
}

function doReblogAjax(type, request, retries, additional) {
   debug("AJAX " + type + " request (" + request.message.pid + ")");
   startAjax(request.message.pid);
   var failMsg = {success:false};
   if (additional) {
      for (i in additional) {
         if (additional.hasOwnProperty(i)) {
            failMsg[i] = additional[i];
         }
      }
   }
   $.ajax({
      type: "GET",
      url: request.message.url,
      dataType: "html",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.message.pid,
      error: function(xhr, textStatus) {
         if (xhr.status === 404) {
            debug(type + " request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            request.target.page.dispatchMessage(type,failMsg);
            return;
         }
         if (request.target.page === undefined) {
            debug("Stop " + type + " request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         if (cacheServe(type, request.message.pid, request, doReblogDash, true)) {
            return true;
         }
         else {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               debug("Retry " + type + " request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               request.target.page.dispatchMessage(type,failMsg);
            }
         }
      },
      success: function(data, textStatus) {
         var ifr = data.match(/<\s*iframe[^>]*id="tumblr_controls"[^>]*>/);
         if (!ifr || ifr.length === 0) {
            if (request.target.page === undefined) {
               debug("Stop " + type + " request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe(type, request.message.pid, request, doReblogDash, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  debug("Retry " + type + " request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  debug(type + " request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  request.target.page.dispatchMessage(type,failMsg);
               }
            }
         }
         else {
            var rk = ifr[0].match(/rk=([^&"']*)/);
            var poster = ifr[0].match(/name=([^&"']*)/);
            var user;
            if (rk && rk.length > 1) {
               if (!poster || poster.length <= 1) {
                  user = "";
               }
               else {
                  user = poster[1];
               }
               var info = {"reblog_key":rk[1],
                           "name":user};
               saveCache(this.targetId, info);
               dequeueAjax(this.targetId);
               if (request.target.page !== undefined) {
                  doReblogDash(info, this.targetId, request);
               }
            }
            else if (request.target.page !== undefined) {
               debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               request.target.page.dispatchMessage(type,failMsg);
            }
         }
      }
   });
}

/*
function doAjax(request, retries, type, doFunc, additional) {
   debug("AJAX " + type + " request (" + request.message.pid + ")");
   startAjax(request.message.pid);
   var failMsg = {success:false};
   if (additional) {
      for (i in additional) {
         if (additional.hasOwnProperty(i)) {
            failMsg[i] = additional[i];
         }
      }
   }
   $.ajax({
      type: "GET",
      url: "http://api.tumblr.com/v2/blog/" +
            request.message.url.replace(/^https?:\/\//,'') +
            "/posts?api_key=" + apiKey + "&id=" + request.message.pid,
      dataType: "text",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.message.pid,
      error: function(xhr, textStatus, thrownError) {
         if (xhr.status === 404) {
            debug(type + " request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            request.target.page.dispatchMessage(type,failMsg);
            return;
         }
         if (request.target.page === undefined) {
            debug("Stop " + type + " request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         if (cacheServe(type, request.message.pid, request, doFunc, true)) {
            return true;
         }
         else {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               debug("Retry " + type + " request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               request.target.page.dispatchMessage(type,failMsg);
            }
         }
      },
      success: function(data, textStatus) {
         if (!(/^\s*var\s+tumblr_api_read/.test(data)) &&
             !(/^\s*{\s*['"]meta['"]\s*:\s*{[^}]*['"]status['"]\s*:\s*200,/
                .test(data))) {
            if (request.target.page === undefined) {
               debug("Stop " + type + " request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe(type, request.message.pid, request, doFunc, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  debug("Retry " + type + " request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  debug(type + " request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  request.target.page.dispatchMessage(type,failMsg);
               }
            }
         }
         else {
            var txt = data.replace(/^\s*var\s+tumblr_api_read\s+=\s+/,'').replace(/;\s*$/,'');
            var stamp = JSON.parse(txt);
            var info = stamp.response.posts[0];
            saveCache(this.targetId, info);
            dequeueAjax(this.targetId);
            if (request.target.page !== undefined) {
               doFunc(info, this.targetId, request);
            }
         }
      }
   });
}
*/

function requestTags(request) {
   if (request.target.page === undefined) {
      debug("Stop tags request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("tags", request.message.pid, request, doTags,
                  false)) {
      return true;
   }
   else if (isRequested({type: "tags", request: request})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "tags", request: request});
   }
   else {
      doTagsAjax(request,
             getStorage("MissingE_betterReblogs_retries",defaultRetries));
   }
}

function requestTimestamp(request) {
   if (request.message.lang) { lang = request.message.lang; }
   if (request.target.page === undefined) {
      debug("Stop timestamp request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("timestamp", request.message.pid, request, doTimestamp,
                  false)) {
      return true;
   }
   else if (isRequested({type: "timestamp", request: request})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "timestamp", request: request});
   }
   else if (request.message.url === 'http://www.tumblr.com/edit/') {
      doAskAjax(request,
                getStorage("MissingE_timestamps_retries",defaultRetries),
                "timestamp", doTimestamp);
   }
   else {
      doAjax(request,
             getStorage("MissingE_timestamps_retries",defaultRetries),
             "timestamp", doTimestamp,
             {pid: request.pid});
   }
}

function requestBetterReblogsAsk(request) {
   if (request.target.page === undefined) {
      debug("Stop betterReblogs request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("betterReblogs", request.message.pid, request,
                  doReblogDash, false)) {
      return true;
   }
   else if (isRequested({type: "betterReblogs", request: request})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "betterReblogs", request: request});
   }
   else {
      doReblogAjax("betterReblogs",request,
             getStorage("MissingE_betterReblogs_askRetries",defaultRetries),
             {
               pid:request.pid,
               icons:getStorage("MissingE_dashboardFixes_enabled",1) == 1 && 
                     getStorage("MissingE_dashboardFixes_replaceIcons",1) == 1
             });
   }
}

function requestReblogYourself(request) {
   if (request.target.page === undefined) {
      debug("Stop reblogYourself request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("reblogYourself", request.message.pid, request,
                  doReblogDash, false)) {
      return true;
   }
   else if (isRequested({type: "reblogYourself", request: request})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "reblogYourself", request: request});
   }
   else {
      doReblogAjax("reblogYourself", request,
             getStorage("MissingE_reblogYourself_retries",defaultRetries),
             {
               pid:request.pid,
               icons:getStorage("MissingE_dashboardFixes_enabled",1) == 1 && 
                     getStorage("MissingE_dashboardFixes_replaceIcons",1) == 1
             });
   }
}

function requestMagnifier(request) {
   if (request.target.page === undefined) {
      debug("Stop magnifier request: Tab closed or changed.");
      return;
   }
   else {
      debug("Building magnifier request (" + request.message.pid + ")");
      var i,url;
      if (request.message.num > 1) {
         url = [];
         for (i=0; i<request.message.num; i++) {
            url.push("http://www.tumblr.com/photo/1280/" +
                     request.message.pid + "/" + (i+1) + "/" +
                     request.message.code);
            url.push(request.message.captions[i]);
         }
         url = JSON.stringify(url);
      }
      else {
         url = "http://www.tumblr.com/photo/1280/" + request.message.pid +
            "/1/" + request.message.code;
      }
      request.target.page.dispatchMessage("magnifier", {pid: request.message.pid,
                                                        success: true,
                                                        data: url});
   }
}

function versionCompare(v1, v2) {
   if (!v1 && !v2) { return 0; }
   else if (!v1) { return -1; }
   else if (!v2) { return 1; }
   else {
      var i;
      var ver1 = v1.split('.');
      var ver2 = v2.split('.');
      var len = ver1.length >= ver2.length ? ver1.length : ver2.length;
      for (i=0; i<len; i++) {
         if (i >= ver1.length && ver2[i] !== '0') { return -1; }
         else if (i >= ver2.length && ver1[i] !== '0') { return 1; }
         else {
            ver1[i] = parseInt(ver1[i]);
            ver2[i] = parseInt(ver2[i]);
         }
         if (ver1[i] > ver2[i]) { return 1; }
         if (ver2[i] > ver1[i]) { return -1; }
      }
      return 0;
   }
}

function closeTab(url, currentTab) {
   var i,j;
   var windows = safari.application.browserWindows;
   for (i=0; i<windows.length; i++) {
      for (j=0; j<windows[i].tabs.length; j++) {
         if (windows[i].tabs[j].url === url &&
             windows[i].tabs[j] !== currentTab) {
            windows[i].tabs[j].close();
         }
      }
   }
}

safari.application.addEventListener("command", performCommand, false);
function performCommand(cmd) {
   if (cmd.command == "missinge-settings") {
      cmd.target.browserWindow.openTab().url = safari.extension.baseURI + "options.html"
   }
}

function isEDTfromUTC(dt) {
   var add;
   var start = new Date("03/01/" + dt.getUTCFullYear() + " 07:00:00 UTC");
   var day = start.getDay();
   if (day === 0) { add = 7; }
   else { add = 14-day; }
   start.setUTCDate(start.getUTCDate()+add);
   var end = new Date("11/01/" + dt.getUTCFullYear() + " 06:00:00 UTC");
   day = end.getDay();
   if (day === 0) { add = 0; }
   else { add = 7-day; }
   end.setUTCDate(end.getUTCDate()+add);
   return (dt>=start && dt<end);
}

function isEDT(year,month,date,hours) {
   var add;
   var start = new Date("03/01/" + year + " 07:00:00 UTC");
   var day = start.getDay();
   if (day === 0) { add = 7; }
   else { add = 14-day; }
   start.setUTCDate(start.getUTCDate()+add);
   var end = new Date("11/01/" + year + " 06:00:00 UTC");
   day = end.getDay();
   if (day === 0) { add = 0; }
   else { add = 7-day; }
   end.setUTCDate(end.getUTCDate()+add);
   if (month>start.getUTCMonth()+1 && month<end.getUTCMonth()+1) {
      return true;
   }
   else if (month === start.getUTCMonth()+1) {
      if (date > start.getUTCDate()) {
         return true;
      }
      else if (date < start.getUTCDate()) {
         return false;
      }
      else {
         if (hours >= 2) {
            return true;
         }
         else {
            return false;
         }
      }
   }
   else if (month === end.getUTCMonth()+1) {
      if (date < end.getUTCDate()) {
         return true;
      }
      else if (date > end.getUTCDate()) {
         return false;
      }
      else {
         if (hours >= 2) {
            return false;
         }
         else {
            return true;
         }
      }
   }
   else {
      return false;
   }
}

safari.application.addEventListener("message", handleRequest, false);
function handleRequest(request) {
   if (request.name == "open") {
      request.target.browserWindow.openTab().url = request.message;
   }
   else if (request.name == "version") {
      request.target.page.dispatchMessage("version",
         {uptodate:(versionCompare(getStorage("MissingE_version",'0'),
                                   request.v) >= 0)});
   }
   else if (request.name == "exportOptions") {
      exportOptionsXML(request);
   }
   else if (request.name == "importOptions") {
      receiveOptions(request);
   }
   else if (request.name == "getAsker") {
      if (askerTable[request.target.url]) {
         debug("Found saved asker for '" + request.target.url + "'");
         var name = askerTable[request.target.url].asker;
         var isSure = askerTable[request.target.url].isSure;
         if (--askerTable[request.target.url].count == 0) {
            debug("Deleting saved asker for '" + request.target.url + "'");
            delete askerTable[request.target.url];
         }
         if (name && name !== "") {
            request.target.page.dispatchMessage("sendAsker",
               {name: name, isSure: isSure, url: request.target.url});
         }
      }
      else {
         if (askerWaiters[request.target.url]) {
            debug("Creating new askerWaiter for '" + request.target.url + "'");
            askerWaiters[request.target.url].push(request);
         }
         else {
            debug("Adding askerWaiter for '" + request.target.url + "'");
            askerWaiters[request.target.url] = [request];
         }
      }
   }
   else if (request.name == "sendAsker") {
      if (askerWaiters[request.target.url]) {
         debug("Found existing askerWaiter for '" + request.target.url + "'");
         var r = askerWaiters[request.target.url].pop();
         if (askerWaiters[request.target.url].length === 0) {
            debug("Deleting existing askerWaiter queue for '" + request.target.url + "'");
            delete askerWaiters[request.target.url];
         }
         if (request.message.name && request.message.name !== "") {
            r.target.page.dispatchMessage("sendAsker",
               {name: request.message.name, isSure: request.message.isSure,
                url: request.target.url});
         }
      }
      else {
         if (askerTable[request.target.url]) {
            debug("Found existing askerTable entry for '" + request.target.url + "'");
            askerTable[request.target.url].count++;
         }
         else {
            debug("Creating askerTable entry for '" + request.target.url + "'");
            askerTable[request.target.url] = {asker: request.message.name,
                                              isSure: request.message.isSure, count:1};
         }
      }
   }
   else if (request.name == "update") {
      request.target.page.dispatchMessage("update",
         {update:versionCompare(getStorage("MissingE_externalVersion",'0'),
                                getStorage("MissingE_version",'0')) > 0});
   }
   else if (request.name == "close-options") {
      closeTab(request.target.url, request.target);
   }
   else if (request.name == "magnifier") {
      requestMagnifier(request);
   }
   else if (request.name == "reblogYourself") {
      requestReblogYourself(request);
   }
   else if (request.name == "betterReblogs") {
      requestBetterReblogsAsk(request);
   }
   else if (request.name == "tags") {
      requestTags(request);
   }
   else if (request.name == "timestamp") {
      if (request.message.type == "ask") {
         requestTimestamp(request);
      }
      else if (cacheServe("timestamp", request.message.pid, request, doTimestamp, false, true)) {
         return true;
      }
      else {
         var sentStamp = false;
         debug("Building timestamp (" + request.message.pid + ")");
         var dt = {};
         var today = new Date();
         if (isEDTfromUTC(today)) {
            today.setUTCHours(today.getUTCHours()-4);
         }
         else {
            today.setUTCHours(today.getUTCHours()-5);
         }
         dt.day = today.getUTCDay();
         var stamp = request.message.stamp.replace(/,/,'').split(" ");
         for (i=0; i<stamp.length; i++) {
            if (/[0-9][0-9][0-9][0-9]$/.test(stamp[i])) {
               dt.year = parseInt(stamp[i]);
            }
            else if (/[0-9][0-9]*:[0-9][0-9]$/.test(stamp[i])) {
               var tmp = stamp[i].match(/([0-9]*):([0-9]*)/);
               dt.hours = parseInt(tmp[1]);
               dt.minutes = parseInt(tmp[2].replace(/^0/,''));
            }
            else if (/[0-9][0-9]*:[0-9][0-9](am|AM|pm|PM)/.test(stamp[i])) {
               var tmp = stamp[i].match(/([0-9]*):([0-9]*)/);
               if (/pm$/i.test(stamp[i])) {
                  dt.hours = parseInt(tmp[1])+12;
                  if (dt.hours === 24) { dt.hours = 12; }
               }
               else {
                  dt.hours = parseInt(tmp[1]);
                  if (dt.hours === 12) { dt.hours = 0; }
               }
               dt.minutes = parseInt(tmp[2].replace(/^0/,''));
            }
            else if (/[0-9][0-9]*\/[0-9][0-9]*\/[0-9][0-9]*/.test(stamp[i])) {
               var tmp = stamp[i].match(/([0-9]*)\/([0-9]*)\/([0-9]*)/);
               dt.date = parseInt(tmp[1]);
               dt.month = parseInt(tmp[2]);
               dt.year = parseInt(tmp[3]);
            }
            else if (/[0-9][0-9]*(st|nd|rd|th)$/.test(stamp[i])) {
               var tmp = stamp[i].match(/([0-9]*)/);
               dt.date = parseInt(tmp[1]);
            }
            else if (/^[A-Za-z]+$/.test(stamp[i])) {
               if (/^jan(uary)?$/i.test(stamp[i])) {
                  dt.month = 1;
               }
               else if (/^feb(ruary)?$/i.test(stamp[i])) {
                  dt.month = 2;
               }
               else if (/^mar(ch)?$/i.test(stamp[i])) {
                  dt.month = 3;
               }
               else if (/^apr(il)?$/i.test(stamp[i])) {
                  dt.month = 4;
               }
               else if (/^may$/i.test(stamp[i])) {
                  dt.month = 5;
               }
               else if (/^jun(e)?$/i.test(stamp[i])) {
                  dt.month = 6;
               }
               else if (/^jul(y)?$/i.test(stamp[i])) {
                  dt.month = 7;
               }
               else if (/^aug(ust)?$/i.test(stamp[i])) {
                  dt.month = 8;
               }
               else if (/^sep(t|tember)?$/i.test(stamp[i])) {
                  dt.month = 9;
               }
               else if (/^oct(ober)?$/i.test(stamp[i])) {
                  dt.month = 10;
               }
               else if (/^nov(ember)?$/i.test(stamp[i])) {
                  dt.month = 11;
               }
               else if (/^dec(ember)?$/i.test(stamp[i])) {
                  dt.month = 12;
               }
               else if (/^sun(day)?$/i.test(stamp[i])) {
                  dt.date = -dt.day; 
               }
               else if (/^mon(day)?$/i.test(stamp[i])) {
                  dt.date = (1-dt.day-7)%7;
               }
               else if (/^tue(s|sday)?$/i.test(stamp[i])) {
                  dt.date = (2-dt.day-7)%7;
               }
               else if (/^wed(nesday)?$/i.test(stamp[i])) {
                  dt.date = (3-dt.day-7)%7;
               }
               else if (/^thu(r|rs|rsday)?$/i.test(stamp[i])) {
                  dt.date = (4-dt.day-7)%7;
               }
               else if (/^fri(day)?$/i.test(stamp[i])) {
                  dt.date = (5-dt.day-7)%7;
               }
               else if (/^sat(urday)?$/i.test(stamp[i])) {
                  dt.date = (6-dt.day-7)%7;
               }
            }
         }
         if (dt.year) {
            var tz = isEDT(dt.year,dt.month,dt.date,dt.hours) ? "EDT" : "EST";
            var d = new Date(dt.month + "/" + dt.date + "/" + dt.year + " " +
                            dt.hours + ":" + dt.minutes + ":00 " + tz);
            var ts = Math.round(d.getTime()/1000);
            var info = {"timestamp":ts};
            saveCache(request.message.pid,info);
            sentStamp = true;
            doTimestamp(info, request.message.pid, request);
         }
         if (!dt.year) {
            if (dt.month) {
               var dq = new Date(dt.month + "/" + dt.date + "/" +
                                 today.getUTCFullYear() + " " + dt.hours +
                                 ":" + dt.minutes + ":00 UTC");
               /* If more than a day ahead, month is in previous year */
               if (dq > today + 86400000) {
                  dt.year = today.getUTCFullYear() - 1;
               }
               else {
                  dt.year = today.getUTCFullYear();
               }
               var tz = isEDT(dt.year,dt.month,dt.date,dt.hours) ? "EDT":"EST";
               var d = new Date(dt.month + "/" + dt.date + "/" + dt.year +
                                " " + dt.hours + ":" + dt.minutes + ":00 " +
                                tz);
               var ts = Math.round(d.getTime()/1000);
               var info = {"timestamp":ts};
               saveCache(request.message.pid,info);
               sentStamp = true;
               doTimestamp(info, request.message.pid, request);
            }
            else if (dt.date < 0) {
               var dq = new Date((today.getUTCMonth()+1) + "/" +
                                 today.getUTCDate() + "/" +
                                 today.getUTCFullYear() + " " + dt.hours +
                                 ":" + dt.minutes + ":00 UTC");
               /* If more than a month ahead, wrapped backwards across year */
               if (dq > today + 2764800000) {
                  today.setUTCFullYear(dt.year);
               }
               /* If more than a day ahead, wrapped backwards across month */
               if (dq > today + 86400000) {
                  today.setUTCMonth(today.getUTCMonth()-1);
               }
               today = new Date(today.valueOf()+86400000*dt.date);
               dt.date = today.getUTCDate();
               dt.month = today.getUTCMonth()+1;
               dt.year = today.getUTCFullYear();
               var tz = isEDT(dt.year,dt.month,dt.date,dt.hours) ? "EDT":"EST";
               var d = new Date(dt.month + "/" + dt.date + "/" + dt.year +
                                " " + dt.hours + ":" + dt.minutes + ":00 " +
                                tz);
               var ts = Math.round(d.getTime()/1000);
               var info = {"timestamp":ts};
               saveCache(request.message.pid,info);
               sentStamp = true;
               doTimestamp(info, request.message.pid, request);
            }
            else if (!dt.date) {
               dt.year = today.getUTCFullYear();
               dt.month = today.getUTCMonth()+1;
               dt.date = today.getUTCDate();
               var tz = isEDT(dt.year,dt.month,dt.date,dt.hours) ? "EDT" : "EST";
               var d = new Date(dt.month + "/" + dt.date + "/" + dt.year + " " +
                              dt.hours + ":" + dt.minutes + ":00 " + tz);
               var ts = Math.round(d.getTime()/1000);
               var info = {"timestamp":ts};
               saveCache(request.message.pid,info);
               sentStamp = true;
               doTimestamp(info, request.message.pid, request);
            }
         }
         if (!sentStamp) {
            request.target.page.dispatchMessage("timestamp",
                                                {pid: id, success: false});
         }
      }
   }
   else if (request.name == "tags") {
      requestTags(request);
   }
   else if (request.name == "change-setting") {
      setStorage(request.message.name, request.message.val);
   }
   else if (request.name == "all-settings") {
      var settings = {};
      settings.MissingE_experimentalFeatures_enabled = getStorage("MissingE_experimentalFeatures_enabled",0);
      for (i=0; i<componentList.length; i++) {
         settings["MissingE_" + componentList[i] + "_enabled"] = getStorage("MissingE_" + componentList[i] + "_enabled", 1);
      }
      settings.MissingE_askFixes_scroll = getStorage("MissingE_askFixes_scroll",1);
      settings.MissingE_askFixes_betterAnswers = getStorage("MissingE_askFixes_betterAnswers",0);
      settings.MissingE_askFixes_tagAsker = getStorage("MissingE_askFixes_tagAsker",1);
      settings.MissingE_askFixes_defaultTags = getStorage("MissingE_askFixes_defaultTags",'');
      settings.MissingE_askFixes_askDash = getStorage("MissingE_askFixes_askDash",0);
      settings.MissingE_askFixes_massDelete = getStorage("MissingE_askFixes_massDelete",1);
      settings.MissingE_bookmarker_format = getStorage("MissingE_bookmarker_format",defaultFormat);
      settings.MissingE_bookmarker_addBar = getStorage("MissingE_bookmarker_addBar",1);
      settings.MissingE_dashboardFixes_reblogQuoteFit = getStorage("MissingE_dashboardFixes_reblogQuoteFit",1);
      settings.MissingE_dashboardFixes_wrapTags = getStorage("MissingE_dashboardFixes_wrapTags",1);
      settings.MissingE_dashboardFixes_replaceIcons = getStorage("MissingE_dashboardFixes_replaceIcons",1);
      settings.MissingE_dashboardFixes_timeoutAJAX = getStorage("MissingE_dashboardFixes_timeoutAJAX",1);
      settings.MissingE_dashboardFixes_timeoutLength = getStorage("MissingE_dashboardFixes_timeoutLength",defaultTimeout);
      settings.MissingE_dashboardFixes_postLinks = getStorage("MissingE_dashboardFixes_postLinks",1);
      settings.MissingE_dashboardFixes_reblogReplies = getStorage("MissingE_dashboardFixes_reblogReplies",0);
      settings.MissingE_dashboardFixes_widescreen = getStorage("MissingE_dashboardFixes_widescreen",0);
      settings.MissingE_dashboardFixes_queueArrows = getStorage("MissingE_dashboardFixes_queueArrows",1);
      settings.MissingE_dashboardFixes_expandAll = getStorage("MissingE_dashboardFixes_expandAll",1);
      settings.MissingE_dashboardFixes_massDelete = getStorage("MissingE_dashboardFixes_massDelete",1);
      settings.MissingE_dashboardFixes_randomQueue = getStorage("MissingE_dashboardFixes_randomQueue",0);
      settings.MissingE_dashboardFixes_sortableNotes = getStorage("MissingE_dashboardFixes_sortableNotes",1);
      settings.MissingE_sidebarTweaks_retries = getStorage("MissingE_sidebarTweaks_retries",defaultRetries);
      settings.MissingE_sidebarTweaks_addSidebar = getStorage("MissingE_sidebarTweaks_addSidebar",0);
      settings.MissingE_sidebarTweaks_slimSidebar = getStorage("MissingE_sidebarTweaks_slimSidebar",0);
      settings.MissingE_sidebarTweaks_followingLink = getStorage("MissingE_sidebarTweaks_followingLink",0);
      settings.MissingE_magnifier_retries = getStorage("MissingE_magnifier_retries",defaultRetries);
      settings.MissingE_magnifier_magnifyAvatars = getStorage("MissingE_magnifier_magnifyAvatars",0);
      settings.MissingE_dashLinksToTabs_newPostTabs = getStorage("MissingE_dashLinksToTabs_newPostTabs",1);
      settings.MissingE_dashLinksToTabs_sidebar = getStorage("MissingE_dashLinksToTabs_sidebar",0);
      settings.MissingE_dashLinksToTabs_reblogLinks = getStorage("MissingE_dashLinksToTabs_reblogLinks",0);
      settings.MissingE_dashLinksToTabs_editLinks = getStorage("MissingE_dashLinksToTabs_editLinks",0);
      settings.MissingE_timestamps_retries = getStorage("MissingE_timestamps_retries",defaultRetries);
      settings.MissingE_timestamps_format = getStorage("MissingE_timestamps_format",defaultFormat);
      settings.MissingE_postingFixes_photoReplies = getStorage("MissingE_postingFixes_photoReplies",1);
      settings.MissingE_postingFixes_uploaderToggle = getStorage("MissingE_postingFixes_uploaderToggle",1);
      settings.MissingE_postingFixes_addUploader = getStorage("MissingE_postingFixes_addUploader",1);
      settings.MissingE_postingFixes_quickButtons = getStorage("MissingE_postingFixes_quickButtons",1);
      settings.MissingE_postingFixes_blogSelect = getStorage("MissingE_postingFixes_blogSelect",0);
      settings.MissingE_postingFixes_subEdit = getStorage("MissingE_postingFixes_subEdit",1);
      settings.MissingE_postingFixes_subEditRetries = getStorage("MissingE_postingFixes_subEditRetries",defaultRetries);
      settings.MissingE_postingFixes_tagQueuedPosts = getStorage("MissingE_postingFixes_tagQueuedPosts",0);
      settings.MissingE_postingFixes_queueTags = getStorage("MissingE_postingFixes_queueTags",'');
      settings.MissingE_reblogYourself_postPage = getStorage("MissingE_reblogYourself_postPage",1);
      settings.MissingE_reblogYourself_dashboard = getStorage("MissingE_reblogYourself_dashboard",1);
      settings.MissingE_reblogYourself_retries = getStorage("MissingE_reblogYourself_retries",defaultRetries);
      settings.MissingE_postCrushes_prefix = getStorage("MissingE_postCrushes_prefix","Tumblr Crushes:");
      settings.MissingE_postCrushes_crushSize = getStorage("MissingE_postCrushes_crushSize",1);
      settings.MissingE_postCrushes_addTags = getStorage("MissingE_postCrushes_addTags",1);
      settings.MissingE_postCrushes_showPercent = getStorage("MissingE_postCrushes_showPercent",1);
      settings.MissingE_replyReplies_showAvatars = getStorage("MissingE_replyReplies_showAvatars",1);
      settings.MissingE_replyReplies_smallAvatars = getStorage("MissingE_replyReplies_smallAvatars",1);
      settings.MissingE_replyReplies_addTags = getStorage("MissingE_replyReplies_addTags",1);
      settings.MissingE_replyReplies_defaultTags = getStorage("MissingE_replyReplies_defaultTags",'');
      settings.MissingE_replyReplies_newTab = getStorage("MissingE_replyReplies_newTab",1);
      settings.MissingE_betterReblogs_passTags = getStorage("MissingE_betterReblogs_passTags",1);
      settings.MissingE_betterReblogs_retries = getStorage("MissingE_betterReblogs_retries",defaultRetries);
      settings.MissingE_betterReblogs_autoFillTags = getStorage("MissingE_betterReblogs_autoFillTags",1);
      settings.MissingE_betterReblogs_quickReblog = getStorage("MissingE_betterReblogs_quickReblog",0);
      settings.MissingE_betterReblogs_quickReblogAcctType = getStorage("MissingE_betterReblogs_quickReblogAcctType",0);
      settings.MissingE_betterReblogs_quickReblogAcctName = getStorage("MissingE_betterReblogs_quickReblogAcctName",'');
      settings.MissingE_betterReblogs_quickReblogForceTwitter = getStorage("MissingE_betterReblogs_quickReblogForceTwitter","default");
      settings.MissingE_betterReblogs_fullText = getStorage("MissingE_betterReblogs_fullText",0);
      settings.MissingE_betterReblogs_reblogAsks = getStorage("MissingE_betterReblogs_reblogAsks",0);
      settings.MissingE_betterReblogs_askRetries = getStorage("MissingE_betterReblogs_askRetries",defaultRetries);
      settings.MissingE_version = getStorage("MissingE_version",'');
      request.target.page.dispatchMessage("all-settings",settings);
   }
   else if (request.name == "sidebarTweaks") {
      setStorage("MissingE_sidebarTweaks_accountNum",
                 request.message.accountNum);
   }
   else if (request.name == "tumblrPermission") {
      checkPermission(request,
                      getStorage("MissingE_postingFixes_subEditRetries",defaultRetries));
   }
   else if (request.name == "settings") {
      var settings = {};
      settings.component = request.message.component;
      settings.experimental = getStorage("MissingE_experimentalFeatures_enabled",0);
      switch(request.message.component) {
         case "askFixes":
            settings.scroll = getStorage("MissingE_askFixes_scroll",1);
            settings.betterAnswers = getStorage("MissingE_askFixes_betterAnswers",0);
            settings.tagAsker = getStorage("MissingE_askFixes_tagAsker",1);
            settings.defaultTags = getStorage("MissingE_askFixes_defaultTags",'');
            if (settings.defaultTags !== '') {
               settings.defaultTags = settings.defaultTags.replace(/, /g,',').split(',');
            }
            settings.askDash = getStorage("MissingE_askFixes_askDash",0);
            settings.massDelete = getStorage("MissingE_askFixes_massDelete",1);
            break;
         case "sidebarTweaks":
            settings.retries = getStorage("MissingE_sidebarTweaks_retries",defaultRetries);
            settings.accountNum = getStorage("MissingE_sidebarTweaks_accountNum",0);
            settings.slimSidebar = getStorage("MissingE_sidebarTweaks_slimSidebar",0);
            settings.followingLink = getStorage("MissingE_sidebarTweaks_followingLink",0);
            settings.addSidebar = getStorage("MissingE_sidebarTweaks_addSidebar",0);
            break;
         case "bookmarker":
            settings.format = getStorage("MissingE_bookmarker_format",defaultFormat);
            settings.addBar = getStorage("MissingE_bookmarker_addBar",1);
            break;
         case "dashboardFixes":
            settings.reblogQuoteFit = getStorage("MissingE_dashboardFixes_reblogQuoteFit",1);
            settings.wrapTags = getStorage("MissingE_dashboardFixes_wrapTags",1);
            settings.replaceIcons = getStorage("MissingE_dashboardFixes_replaceIcons",1);
            settings.timeoutAJAX = getStorage("MissingE_dashboardFixes_timeoutAJAX",1);
            settings.timeoutLength = getStorage("MissingE_dashboardFixes_timeoutLength",defaultTimeout);
            settings.postLinks = getStorage("MissingE_dashboardFixes_postLinks",1);
            settings.reblogReplies = getStorage("MissingE_dashboardFixes_reblogReplies",0);
            settings.widescreen = getStorage("MissingE_dashboardFixes_widescreen",0);
            settings.queueArrows = getStorage("MissingE_dashboardFixes_queueArrows",1);
            settings.expandAll = getStorage("MissingE_dashboardFixes_expandAll",1);
            settings.massDelete = getStorage("MissingE_dashboardFixes_massDelete",1);
            settings.randomQueue = getStorage("MissingE_dashboardFixes_randomQueue",0);
            settings.sortableNotes = getStorage("MissingE_dashboardFixes_sortableNotes",1);
            break;
         case "dashLinksToTabs":
            settings.newPostTabs = getStorage("MissingE_dashLinksToTabs_newPostTabs",1);
            settings.sidebar = getStorage("MissingE_dashLinksToTabs_sidebar",0);
            settings.reblogLinks = getStorage("MissingE_dashLinksToTabs_reblogLinks",0);
            settings.editLinks = getStorage("MissingE_dashLinksToTabs_editLinks",0);
            break;
         case "replyReplies":
            settings.showAvatars = getStorage("MissingE_replyReplies_showAvatars",1);
            settings.smallAvatars = getStorage("MissingE_replyReplies_smallAvatars",1);
            settings.addTags = getStorage("MissingE_replyReplies_addTags",1);
            settings.defaultTags = getStorage("MissingE_replyReplies_defaultTags",'');
            if (settings.defaultTags !== '') {
               settings.defaultTags = settings.defaultTags.replace(/, /g,',').split(',');
            }
            settings.newTab = getStorage("MissingE_replyReplies_newTab",1);
            break;
         case "postCrushes_fill":
         case "postCrushes":
            settings.prefix = getStorage("MissingE_postCrushes_prefix","Tumblr Crushes:");
            settings.crushSize = getStorage("MissingE_postCrushes_crushSize",1);
            settings.addTags = getStorage("MissingE_postCrushes_addTags",1);
            settings.showPercent = getStorage("MissingE_postCrushes_showPercent",1);
            break;
         case "postingFixes":
            settings.photoReplies = getStorage("MissingE_postingFixes_photoReplies",1);
            settings.uploaderToggle = getStorage("MissingE_postingFixes_uploaderToggle",1);
            settings.addUploader = getStorage("MissingE_postingFixes_addUploader",1);
            settings.quickButtons = getStorage("MissingE_postingFixes_quickButtons",1);
            settings.blogSelect = getStorage("MissingE_postingFixes_blogSelect",0);
            settings.tagQueuedPosts = getStorage("MissingE_postingFixes_tagQueuedPosts",0);
            settings.queueTags = getStorage("MissingE_postingFixes_queueTags",'');
            if (settings.queueTags !== '') {
               settings.queueTags = settings.queueTags.replace(/, /g,',').split(',');
            }
            break;
         case "magnifier":
            settings.magnifyAvatars = getStorage("MissingE_magnifier_magnifyAvatars",0);
            break;
         case "betterReblogs":
            settings.passTags = getStorage("MissingE_betterReblogs_passTags",1);
            settings.autoFillTags = getStorage("MissingE_betterReblogs_autoFillTags",1);
            settings.quickReblog = getStorage("MissingE_betterReblogs_quickReblog",0);
            settings.accountName = '0';
            if (getStorage("MissingE_betterReblogs_quickReblogAcctType",0) == 1) {
               settings.accountName = getStorage("MissingE_betterReblogs_quickReblogAcctName",'0');
            }
            settings.quickReblogForceTwitter = getStorage("MissingE_betterReblogs_quickReblogForceTwitter","default");
            settings.replaceIcons = (getStorage("MissingE_dashboardFixes_enabled",1) == 1 && getStorage("MissingE_dashboardFixes_replaceIcons",1) == 1) ? 1 : 0;
            settings.fullText = getStorage("MissingE_betterReblogs_fullText",0);
            settings.tagQueuedPosts = (getStorage("MissingE_postingFixes_enabled",1) == 1 && getStorage("MissingE_postingFixes_tagQueuedPosts",0) == 1) ? 1: 0;
            settings.queueTags = getStorage("MissingE_postingFixes_queueTags",'');
            if (settings.queueTags !== '') {
               settings.queueTags = settings.queueTags.replace(/, /g,',').split(',');
            }
            settings.reblogAsks = getStorage("MissingE_betterReblogs_reblogAsks",0);
            break;
      }
      request.target.page.dispatchMessage("settings",settings);
   }
   else if (request.name == "start") {
      var activeScripts = {url: request.message.url};
      activeScripts.version = currVersion;
      if (!request.message.isFrame &&
          /http:\/\/www\.tumblr\.com\/mega-editor\//.test(request.message.url)) {
         if (getStorage("MissingE_massEditor_enabled",1) == 1) {
            activeScripts.massEditor = true;
         }
         else
            activeScripts.massEditor = false;
      }
      if (!request.message.isFrame &&
          (/http:\/\/www\.tumblr\.com\/dashboard/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/drafts/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/likes/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/liked\/by\//.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/submissions/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/messages/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/inbox/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/queue/.test(request.message.url) ||
          (/http:\/\/www\.tumblr\.com\/blog/.test(request.message.url) &&
           !(/http:\/\/www\.tumblr\.com\/blog\/[^\/]*\/new\//
             .test(request.message.url)) &&
           !(/http:\/\/www\.tumblr\.com\/blog\/[^\/]*\/processing/
             .test(request.message.url))) ||
          /http:\/\/www\.tumblr\.com\/tagged\//.test(request.message.url))) {
         if (getStorage("MissingE_safeDash_enabled",1) == 1) {
            activeScripts.safeDash = true;
         }
         else
            activeScripts.safeDash = false;
      }
      if (!request.message.isFrame &&
          (/http:\/\/www\.tumblr\.com\/dashboard/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/drafts/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/likes/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/liked\/by\//.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/submissions/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/messages/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/inbox/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/queue/.test(request.message.url) ||
          (/http:\/\/www\.tumblr\.com\/blog/.test(request.message.url) &&
           !(/http:\/\/www\.tumblr\.com\/blog\/[^\/]*\/new\//
             .test(request.message.url))) ||
          /http:\/\/www\.tumblr\.com\/tagged\//.test(request.message.url))) {
         if (getStorage("MissingE_dashLinksToTabs_enabled",1) == 1) {
            activeScripts.dashLinksToTabs = true;
         }
         else
            activeScripts.dashLinksToTabs = false;

         if (getStorage("MissingE_bookmarker_enabled",1) == 1) {
            activeScripts.bookmarker = true;
         }
         else
            activeScripts.bookmarker = false;

         if (getStorage("MissingE_magnifier_enabled",1) == 1) {
            activeScripts.zindexFix = true;
         }

         if (getStorage("MissingE_sidebarTweaks_enabled",1) == 1) {
            activeScripts.sidebarTweaks = true;
         }
         else
            activeScripts.sidebarTweaks = false;

         if (getStorage("MissingE_magnifier_enabled",1) == 1) {
            activeScripts.magnifier = true;
         }
         else
            activeScripts.magnifier = false;

         if (getStorage("MissingE_dashboardFixes_enabled",1) == 1) {
            activeScripts.dashboardFixes = true;
         }
         else
            activeScripts.dashboardFixes = false;

         if (getStorage("MissingE_askFixes_enabled",1) == 1) {
            activeScripts.askFixes = true;
         }
         else
            activeScripts.askFixes = false;
      }
      if (/http:\/\/www\.tumblr\.com\/ask_form\//.test(request.message.url)) {
         if (getStorage("MissingE_askFixes_enabled",1) == 1 &&
             getStorage("MissingE_askFixes_scroll",1) == 1) {
            activeScripts.askFixes = true;
         }
         else
            activeScripts.askFixes = false;
      }
      if (!request.message.isFrame &&
          ((/http:\/\/www\.tumblr\.com\/new\//.test(request.message.url) ||
            /http:\/\/www\.tumblr\.com\/blog\/[0-9A-Za-z\-\_]+\/new\//.test(request.message.url) ||
            /http:\/\/www\.tumblr\.com\/reblog\//.test(request.message.url) ||
            /http:\/\/www\.tumblr\.com\/edit\/[0-9]+/.test(request.message.url)) ||
         (/http:\/\/www\.tumblr\.com\/messages/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/inbox/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/blog\/[A-Za-z0-9\-\_]+\/messages/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/submissions/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/blog\/[A-Za-z0-9\-\_]+\/submissions/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/blog\/[^\/]*\/drafts/.test(request.message.url)) ||
         (/http:\/\/www\.tumblr\.com\/share/.test(request.message.url)))) {
         if (getStorage("MissingE_postingFixes_enabled",1) == 1) {
            activeScripts.postingFixes = true;
         }
         else
            activeScripts.postingFixes = false;
      }
      if (!request.message.isFrame &&
          /http:\/\/www\.tumblr\.com\/reblog\//.test(request.message.url)) {
         if (getStorage("MissingE_betterReblogs_enabled",1) == 1) {
            activeScripts.betterReblogs = true;
            activeScripts.betterReblogs_fill = true;
         }
         else
            activeScripts.betterReblogs = false;
      }
      if (/http:\/\/www\.tumblr\.com\/dashboard\/iframe/.test(request.message.url) &&
          !(/http:\/\/www\.tumblr\.com\/edit\/[0-9]+/.test(request.message.url)) &&
          !(/http:\/\/www\.tumblr\.com\/blog\/[A-Za-z0-9\-\_]+\/new\//.test(request.message.url)) &&
          !(/http:\/\/www\.tumblr\.com\/new\//.test(request.message.url))) {
         if (getStorage("MissingE_gotoDashPost_enabled",1) == 1) {
            activeScripts.gotoDashPost = true;
         }
         else
            activeScripts.gotoDashPost = false;

         if (getStorage("MissingE_reblogYourself_enabled",1) == 1 &&
             getStorage("MissingE_reblogYourself_postPage",1) == 1) {
            activeScripts.reblogYourself = true;
         }
         else
            activeScripts.reblogYourself = false;

         if (getStorage("MissingE_betterReblogs_enabled",1) == 1 &&
             getStorage("MissingE_betterReblogs_passTags",1) == 1) {
            activeScripts.betterReblogs = true;
         }
         else
            activeScripts.betterReblogs = false;

         if (getStorage("MissingE_postingFixes_enabled",1) == 1 &&
             getStorage("MissingE_postingFixes_subEdit",1) == 1) {
            activeScripts.postingFixes = true;
         }
         else
            activeScripts.postingFixes = false;
      }
      if (!request.message.isFrame &&
          (/http:\/\/www\.tumblr\.com\/dashboard/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/blog/.test(request.message.url))) {
         if (getStorage("MissingE_replyReplies_enabled",1) == 1) {
            activeScripts.replyReplies = true;
            activeScripts.replyReplies_fill = false;
         }
         else
            activeScripts.replyReplies = false;
      }
      if (!request.message.isFrame &&
          /http:\/\/www\.tumblr\.com\/(blog\/[^\/]*\/)?new\/(text|photo)/.test(request.message.url)) {
         if (getStorage("MissingE_replyReplies_enabled",1) == 1) {
            activeScripts.replyReplies = true;
            activeScripts.replyReplies_fill = true;
         }
         else
            activeScripts.replyReplies = false;
      }
      if (!request.message.isFrame &&
          /http:\/\/www\.tumblr\.com\/following/.test(request.message.url)) {
         if (getStorage("MissingE_postCrushes_enabled",1) == 1) {
            activeScripts.postCrushes = true;
            activeScripts.postCrushes_fill = false;
         }
         else
            activeScripts.postCrushes = false;

         if (getStorage("MissingE_magnifier_enabled",1) == 1) {
            activeScripts.zindexFix = true;
            activeScripts.magnifier = true;
         }
         else
            activeScripts.magnifier = false;
      }
      if (!request.message.isFrame &&
          /http:\/\/www\.tumblr\.com\/new\/photo/.test(request.message.url)) {
         if (getStorage("MissingE_postCrushes_enabled",1) == 1) {
            activeScripts.postCrushes = true;
            activeScripts.postCrushes_fill = true;
         }
         else
            activeScripts.postCrushes = false;
      }
      if (!request.message.isFrame &&
          (/http:\/\/www\.tumblr\.com\/(submissions|messages|inbox)/.test(request.message.url) ||
           /http:\/\/www\.tumblr\.com\/blog\/[^\/]*\/(submissions|messages)/.test(request.message.url))) {
         if (getStorage("MissingE_timestamps_enabled",1) == 1) {
            activeScripts.timestamps = true;
         }
         else
            activeScripts.timestamps = false;
      }
      if (!request.message.isFrame &&
          (/http:\/\/www\.tumblr\.com\/dashboard/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/blog/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/likes/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/liked\/by\//.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/tagged\//.test(request.message.url)) &&
          !(/http:\/\/www\.tumblr\.com\/blog\/[^\/]*\/(submissions|messages|drafts|queue)/.test(request.message.url)) &&
          !(/http:\/\/www\.tumblr\.com\/blog\/[^\/]*\/new\//.test(request.message.url))) {
         if (getStorage("MissingE_timestamps_enabled",1) == 1) {
            activeScripts.timestamps = true;
         }
         else
            activeScripts.timestamps = false;

         if (getStorage("MissingE_betterReblogs_enabled",1) == 1) {
            if (getStorage("MissingE_betterReblogs_quickReblog",0) == 1) {
               activeScripts.zindexFix = true;
            }
            activeScripts.betterReblogs = true;
         }
         else
            activeScripts.betterReblogs = false;

         if (getStorage("MissingE_reblogYourself_enabled",1) == 1 &&
             getStorage("MissingE_reblogYourself_dashboard",1) == 1) {
            activeScripts.reblogYourself = true;
         }
         else
            activeScripts.reblogYourself = false;
      }

      activeScripts.url = request.message.url;
      activeScripts.isFrame = request.message.isFrame;
      request.target.page.dispatchMessage("startup",activeScripts);
   }
}

function collapseSettings(toPref, oldA, oldB) {
   var prefA = safari.extension.settings.getItem(oldA);
   var prefB = safari.extension.settings.getItem(oldB);
   var newPref = 0;

   if (prefA || prefB) {
      console.log('"' + oldA + '" and "' + oldB + '" depracated. Moving settings to "' + toPref + '"');
   }
   if (prefA === 1 || prefB === 1) {
      newPref = 1;
   }
   if (prefA !== undefined || prefB !== undefined) {
      if (safari.extension.settings.getItem(toPref) === null) {
         safari.extension.settings[toPref] = newPref;
      }
      safari.extension.settings.removeItem(oldA);
      safari.extension.settings.removeItem(oldB);
   }
}

function moveSetting(oldpref, newpref) {
   var pref;
   if ((pref = safari.extension.settings.getItem(oldpref))) {
      console.log('"' + oldpref + '" depracated. Moving setting to "' + newpref + '"');
      if (safari.extension.settings.getItem(newpref) === null) {
         safari.extension.settings[newpref] = pref;
      }
      safari.extension.settings.removeItem(oldpref);
   }
}

function invertSetting(oldpref, newpref) {
   var pref;
   if ((pref = safari.extension.settings.getItem(oldpref))) {
      console.log('"' + oldpref + '" changed to inverted setting "' + newpref + '"');
      if (safari.extension.settings.getItem(newPref) === null) {
         safari.extension.settings[newpref] = (pref === 1 ? 0 : 1);
      }
      safari.extension.settings.removeItem(oldpref);
   }
}

function getExternalVersion() {
   $.ajax({
      type: "GET",
      url: 'http://missinge.infraware.ca/version',
      dataType: "text",
      success: function(data, textStatus, xhr) {
         var versionInfo = data.split(" ");
         versionInfo[versionInfo.length-1] =
            versionInfo[versionInfo.length-1].replace(/\s*$/m,'');
         setStorage('MissingE_externalVersion', versionInfo[0]);
         if (versionInfo.length > 1) {
            setStorage('MissingE_externalVersion_link', versionInfo[1]);
         }
         else {
            setStorage('MissingE_externalVersion_link', '');
         }
      }
   });
}

function onStart(currVersion, prevVersion) {
   if (prevVersion && prevVersion !== currVersion) {
      console.log("Updated Missing e (" +
                  prevVersion + " => " + currVersion +
                  ")");
   }
   else if (!prevVersion) {
      console.log("Installed Missing e " + currVersion);
      var options = safari.application.activeBrowserWindow.openTab().url =
         safari.extension.baseURI + "options.html";
   }
   setStorage('MissingE_installedVersion',currVersion);
}

safari.extension.addContentStyleSheetFromURL(safari.extension.baseURI +
                                             "common/widenIframe.css",
                                             "http://*");
safari.extension.addContentScriptFromURL(safari.extension.baseURI +
                                         "betterReblogs/permalink.js",
                                         "http://*", null, true);

onStart(currVersion, prevVersion);
getExternalVersion();

moveSetting('MissingE_dashboardFixes_slimSidebar','MissingE_sidebarTweaks_slimSidebar');
moveSetting('MissingE_dashboardFixes_followingLink','MissingE_sidebarTweaks_followingLink');
collapseSettings('MissingE_askFixes_betterAnswers','MissingE_askFixes_buttons','MissingE_askFixes_tags');
invertSetting('MissingE_betterReblogs_noPassTags','MissingE_betterReblogs_passTags');
</script>
</head>
</html>
